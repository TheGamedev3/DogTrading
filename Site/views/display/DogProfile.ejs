<!DOCTYPE html>
<html>
<head>
  <title><%= dog.name || "Unnamed Dog" %> | Dog Profile</title>
</head>
<body style="font-family: sans-serif; margin: 0; padding: 0;">

    <%- include('../shared/Header') %>

    <main style="padding: 2rem; max-width: 600px; margin: auto;">

    <h1 id="dogName"></h1>
    <input id="editDogName" type="text" value="" style="display: none; font-size: 2rem; width: 100%;" />

    <div style="margin: 1rem 0;">
      <img id="profilePicture" src="" alt="Dog profile picture" style="max-width: 100%; border-radius: 8px; border: 1px solid #ccc;" />
      <p id="profileUnavailable"><em>No profile picture available.</em></p>
      <input id="editProfileURL" type="text" value="" style="display: none; width: 100%;" />
      <button id="editProfileBtn" style="margin-top: 0.5rem;">Edit Profile Picture</button>
    </div>

    <p><strong>Owner:</strong>
      <a id="ownerLink" href="" style="color: #3366cc;">
      </a>
    </p>

    <!-- ⚙️ Display Info logic -->
    <script>
      StaticState(({ DynamicEJSelements, session, refresh, request, onFirstRun }) => {
        const [
          dogName, editDogName,
          profilePicture, profileUnavailable, editProfileURL,
          editProfileBtn,
          ownerLink
        ] = DynamicEJSelements(
          "dogName", "editDogName",
          "profilePicture", "profileUnavailable", "editProfileURL",
          "editProfileBtn",
          "ownerLink"
        );

        let dog = session.dog;
        let ownedByViewer = session.userId && (dog.owner._id.toString() === session.userId.toString());
        
        async function updateDog(){
          const[success2, result2]=await request(`GET /dog/${dog._id}`);
          if(!success2){throw result2}
          session.dog = result2;
          refresh();
        }

        onFirstRun(()=>session.editing = false);
        let editMode = session.editing;
        
        /////////////////////////////////////////

        dogName.set({text:dog.name || "unnamed dog", visible:!editMode});
        editDogName.set({value:dog.name, placeholderText:"Enter a name!", visible:editMode});

        profilePicture.set({src:dog.profile, visible:dog.profile});
        profileUnavailable.set({text:'[image missing or unavailable]', visible:!dog.profile});
        editProfileURL.set({value:dog.profile, placeholderText:"Enter an img url!", visible:editMode});

        editProfileBtn.set({text:"edit?", defaultState:true});
        editProfileBtn.onClick(()=>{
          editMode = !editMode;
          session.editing = editMode;
          editProfileBtn.set(
            editMode
            ? {text:"view dog?", color: "green"}
            : {text:"edit dog?", color: "blue"}
          );
          refresh();
        });

        /////////////////////////////////////////
        // 📝 onTextSubmit for name
        editDogName.onTextSubmit(async (value) => {
          const newName = value.trim();
          if (newName === dog.name) return;
          const [success, result] = await request(`PATCH /editDog/${dog._id}`, { name: newName });
          console.log(result)
          if(!success){
            // blank name error
            if(result && result.server.includes("`name` is required")){
              editDogName.displayError("name field can't be blank!");
            }else{
              // misc error
              editDogName.displayError("invalid name!");
            }
            throw result;
          }else{
            editDogName.clearError();
          }
          await updateDog();
        });

        /////////////////////////////////////////
        // 🖼️ onTextSubmit for profile URL
        editProfileURL.onTextSubmit(async (value) => {
          const newURL = value.trim();
          if (newURL === dog.profile) return;

          profilePicture.set({ visible: true, src: newURL });
          
          const [success, result] = await request(`PATCH /editDog/${dog._id}`, { profile: newURL });
          if (!success) throw result;
          await updateDog();
        });

        /////////////////////////////////////////
      });
    </script>

    <!-- 🐶 Dog Status -->
    <p>
      <strong>Status:</strong>
      <span id="DogStatus"></span>
    </p>

    <!-- 🤝 Trade Panel -->
    <div id="TradePanel" style="margin-top: 2rem; background-color: #f9f9f9; padding: 1rem; border: 1px solid #ddd;">
      <p></p>
      <button id="BuyBtn" style="padding: 0.6rem 1.2rem; font-size: 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"></button>
    </div>

    <!-- 👤 MyDog Panel -->
    <div id="MyDog" style="margin-top: 2rem; background-color: #eef; padding: 1rem; border: 1px solid #ccc;">
      <h2>This is one of your dogs!</h2>
      <p></p>
      <button id="Sell" style="margin-right: 1rem;"></button>
      <button id="UnsellBtn"></button>
      <button id="UnregisterBtn"></button>
    </div>

    <!-- ⚙️ Trade logic -->
    <script>
      StaticState(({ DynamicEJSelements, session, refresh, request }) => {
        const [
          DogStatus,
          TradePanel, BuyBtn,
          MyDog, Sell, UnsellBtn
        ] = DynamicEJSelements(
          'DogStatus',
          'TradePanel', 'BuyBtn',
          'MyDog', 'Sell', 'UnsellBtn', 'UnregisterBtn'
        );

        let dog = session.dog;
        let ownedByViewer = session.userId && (dog.owner._id.toString() === session.userId.toString());
        let hasOffer = Boolean(dog.offer) && dog.offer.status === 'available';
        let isTraded = !ownedByViewer && hasOffer;
        
        async function updateDog(){
          const[success2, result2]=await request(`GET /dog/${dog._id}`);
          if(!success2){throw result2}
          session.dog = result2;
          refresh();
        }
        
        DogStatus.set({text: hasOffer ? 'Avaliable' : 'Not For Sale'});

        /////////////////////////////////////////

        TradePanel.set({visible: isTraded});
        BuyBtn.set({text:"BUY BUY", background:'green', color:'white', enabled:true, defaultState:true});
        BuyBtn.onClick(async()=>{
          BuyBtn.set({text:"purchasing...", background:'blue', disabled:true});
          const[success, result]=await request(`POST /buyOffer/${dog.offer._id}`);
          if(!success){throw result}

          updateDog();
        });

        /////////////////////////////////////////

        MyDog.set({visible: ownedByViewer});

        Sell.set({text:"SELL SELL", background:'red', color:'white', enabled:true, defaultState:true});
        Sell.set({visible:!hasOffer});
        Sell.onClick(async()=>{
          Sell.set({text:"selling...", background:'brown', disabled:true});
          const[success, result]=await request(`POST /makeOffer/${dog._id}`);
          if(!success){throw result}
          await updateDog();
          Sell.set({text:"SELL SELL", background:'red', enabled:true});
        });

        UnsellBtn.set({text:"UNSELL", background:'green', color:'white', enabled:true, defaultState:true});
        UnsellBtn.set({visible:hasOffer});
        UnsellBtn.onClick(async()=>{
          UnsellBtn.set({text:"recollecting...", background:'black', disabled:true});
          const[success, result]=await request(`DELETE /deleteOffer/${dog.offer._id}`);
          if(!success){throw result}
          await updateDog();
          UnsellBtn.set({text:"UNSELL", background:'green', enabled:true});
        });

        /////////////////////////////////////////
      });
    </script>

  </main>

</body>
</html>
